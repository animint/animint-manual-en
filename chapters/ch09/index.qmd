# Montreal bikes

```{r setup, echo=FALSE}
knitr::opts_chunk$set(fig.path="ch09-figures/")
```

In this chapter we will explore several data visualizations of the
Montreal bike data set.

Chapter outline:

* We begin with some static data visualizations.
* We create an interactive visualization of accident frequency over
  time.
* We create a interactive data viz with four plots, showing monthly
  accident trends, daily details, and a map of counter locations.

## Static figures {#static-bikes}

We begin by loading the `montreal.bikes` data set, which is not
available in the CRAN release of `animint2`, in order to save space on
CRAN. Therefore to access this data set, you will need to install
`animint2` from GitHub:

```{r ghinstall}
tryCatch({
  data(montreal.bikes, package="animint2")
}, warning=function(w){
  remotes::install_github("tdhock/animint2")
})
```

The data are two time series:

* `montreal.bikes$counter.counts` are daily counts of bikers from counting machines, with one row per combination of location and day.
* `montreal.bikes$accidents` has one row per accident.

We will compute monthly summaries of these two time series.

### Counters

We begin by examining the data table of counts.

```{r accidents}
month_str <- function(POSIXct)strftime(POSIXct, "%Y-%m")
library(data.table)
data(montreal.bikes, package="animint2")#works if installed from github
(counts_dt <- data.table(montreal.bikes$counter.counts)[, .(
  location, date, month.str=month_str(date), count)])
```

Above we see one row for each combination of location and date.
The bike counts are time series data which we visualize below.

```{r counterviz}
counts_dt[, loc.lines := gsub("[- _]", "\n", location)]
library(animint2)
ggplot()+
  theme_bw()+
  theme(panel.margin=grid::unit(0, "lines"))+
  facet_grid(loc.lines ~ .)+
  geom_point(aes(
    date, count, color=count==0),
    data=counts_dt)+
  scale_color_manual(values=c("TRUE"="grey", "FALSE"="black"))
```

In the figure above, we clearly see the seasonal regularity (fewer bikers in winter).
It is also easy to see the difference between zeros and missing values.

### Accidents

Next we examine one row from the accidents data table.

```{r}
montreal.bikes$accidents[1,]
```

Each accident has data about its date, time, location, and counts of death and slight/severe injury. Some of the values are in French (for example, `Voie de circulation`, `En intersection`, etc).
For the injury count columns, we create abbreviated column names using the code below.

```{r}
severity <- c(
  deaths="deaths",
  severe="people.severely.injured",
  slight="people.slightly.injured")
montreal.bikes$accidents[, names(severity)] <-
  montreal.bikes$accidents[, severity]
accidents_dt <- data.table(montreal.bikes$accidents[, c(
  "date.str", "time.str", names(severity),
  "street", "street.number", "cross.street")])
```

In the code below, we add a column for the month.

```{r}
ymd2POSIXct <- function(date.str){
  as.POSIXct(strptime(date.str, "%Y-%m-%d"))
}
(accidents_dt[
, date := ymd2POSIXct(date.str)
][
, month.str := month_str(date)
][])
```

```{r}
accidents.dt[1]
(accidents.dt[
, date.POSIXct := as.POSIXct(strptime(date.str, "%Y-%m-%d"))
][
, month.str := strftime(date.POSIXct, "%Y-%m")
][])
```

In the output above, we see that the last months for the accidents are not the same as for the counter data.
We compare the time intervals using the code below:

```{r}
data.list <- list(accidents=accidents_dt, counts=counts_dt)
sapply(data.list, function(DT)range(DT$month.str))
```

The output above shows that the accidents start and finish after the counts time series.
Next, to compute a summary for each month, we begin by computing the unique values of month in the range of the two data sets.

```{r}
uniq.month.vec <- unique(c(
  accidents_dt$month.str,
  counts_dt$month.str))
month_01 <- function(mois)ymd2POSIXct(paste0(mois, "-01"))
month_dt <- data.table(month.01 = month_01(uniq.mois.vec))
```

The code below defines the locale so that we can be sure to have the month names in English.

```{r counterRange}
old.locale <- Sys.setlocale(locale="en_US.UTF-8")
month_english <- function(POSIXct)strftime(POSIXct, "%B %Y")
month_dt[, month.english := month_english(month.01)][]
```

The output above contains a row for each month.
<!-- comment -->
Note that we have created the `month.english` variable which will be used for month selection.
<!-- comment -->
In the code below, we compute the total number of accidents of each type per month.

```{r months}
(accidents.per.month <- dcast(
  accidents_dt,
  month.str ~ .,
  sum,
  value.var=names(severity)))
```

The result above shows one row per month, with different columns for each level of severity.
We reshape those columns into long format using the code below.

```{r}
(accidents.tall <- melt(
  accidents.per.month,
  measure.vars=names(severity),
  variable.name="severity",
  value.name="people"))
```

Above we see one row for each combination of month and severity.
In the code below, we use these data to plot the number of accidents in each month.

```{r}
severity.colors <- c(
  deaths="#A50F15",#dark red
  severe="#FB6A4A",
  slight="#FEE0D2")#lite red
ggplot()+
  theme_bw()+
  geom_bar(aes(
    month_01(month.str), people, fill=severity),
    stat="identity",
    data=accidents.tall)+
  scale_fill_manual(
    values=severity.colors, breaks=names(severity.colors))+
  scale_x_datetime("month")
```

The figure above is a time series of the number of deaths and injuries.
The output above shows that accidents with only slight injuries are
most frequent, and accidents with at least one death are least
frequent.

## Interactive viz of accident frequency {#regression}

In this section, we want to compare, for each month, the data for counters and accidents.
Do we have more accidents when there are more bikes on the road?
To check, we will fit a regression model, where each observation is a month with both kinds of data.
First, we compute a summary of counts per month using the code below.

```{r}
(counts.per.month <- dcast(
  counts_dt[!is.na(count)],
  location + month.str ~ .,
  list(length, mean, sum),
  value.var="count"))
```

The output above has one row per combination of location and month, with columns for:

* `count_length`: the number of days.
* `count_mean`: the mean count per day.
* `count_sum`: the total number of counts in that month.

We can see that some months have missing days.
For example, there are only 18 days for `Totem_Laurier` in September 2013.
To model only whole months, we would like to remove months with missing days.
Therefore, we use the code below to compute the number of days in each month:

```{r}
one.day <- 60 * 60 * 24
next_month <- function(POSIXct)month_01(POSIXct + one.day * 31)
counts.per.month[, days.in.month := as.integer(round(difftime(
  month_01(month_str(next_month(month_01(month.str)))),
  month_01(month.str),
  units="days"
)))][]
```

The output above contains the new column `days.in.month`.
We use the code below to print only the months with missing days:

```{r}
counts.per.month[
  count_length < days.in.month,
  .(location, month.str, count_length, days.in.month)]
```

The data shown above are excluded from regression analysis using the code below.

```{r}
complete.months <- counts.per.month[count_length == days.in.month]
```

Next, we make a table with counts and accidents in different columns:

```{r}
city.wide.complete <- complete.months[count_sum>0, .(
  locations=.N,
  total.counts=sum(count_sum)
), keyby=month.str]
city.wide.accidents <- accidents_dt[, .(
  total.accidents=.N
), keyby=month.str]
(scatter.not.na <- city.wide.accidents[
  city.wide.complete, nomatch=0L
][, month.01 := month_01(month.str)][])
```

The output above shows one row per month with both count and acciednt data.
Next, we fit a linear model which uses counts to predict accidents.

```{r}
(fit <- lm(total.accidents ~ total.counts - 1, scatter.not.na))
scatter.not.na[, mean(total.accidents/total.counts)]
scatter.not.na[, sum(total.accidents)/sum(total.counts)]
```

The output above shows that the estimated linear model coefficient is similar to the estimated empirical means.
Finally, we use the code below to create an interactive graphic.

```{r ch09-viz-regression}
scatter.not.na[, let(
  pred.accidents = predict(fit),
  month.english = month_english(month.01)
)]
animint(
  regression=ggplot()+
    theme_bw()+
    ggtitle("Numbers of accidents and cyclists")+
    geom_line(aes(
      total.counts, pred.accidents),
      color="grey",
      data=scatter.not.na)+
    geom_point(aes(
      total.counts, total.accidents),
      clickSelects="month.english",
      size=5,
      alpha=0.75,
      data=scatter.not.na)+
    ylab("Total bike accidents (all Montreal locations)")+
    xlab("Total cyclists (all Montreal locations)"),
  timeSeries=ggplot()+
    theme_bw()+
    ggtitle("Time series of accident frequency")+
    xlab("Month")+
    geom_point(aes(
      month.01, total.accidents/total.counts),
      clickSelects="month.english",             
      size=5,
      alpha=0.75,
      data=scatter.not.na))
```

The data viz above shows two data visualizations of city-wide accident
frequency over time. The plot on the left shows that the number of
accidents grows with the number of cyclists. The plot on the right
shows the frequency of accidents over time.

## Interactive viz with map and details {#details}
TODO

The plot below is a dotplot of accidents for each month. Each dot
represents one person who got in an accident.

In each accident, there are counts of people who died, along with
people who suffered severe and slight injuries. Below we classify the
severity of each accident according to the worst outcome among the
people affected.

```{r}
accidents.dt[
, severity.str := fcase(
  0 < deaths, "deaths",
  0 < people.severely.injured, "people.severely.injured",
  default="people.slightly.injured")
][
, severity := factor(severity.str, names(severity.colors))
][
, table(severity)
]
```



```{r}
accidents.cumsum <- accidents.dt[
  order(date.POSIXct, month, severity)
][
, accident.i := seq_along(severity)
, by=.(date.POSIXct, month)
][
, day.of.the.month := as.integer(strftime(date.POSIXct, "%d"))
][]
ggplot()+
  theme_bw()+
  theme(panel.margin=grid::unit(0, "cm"))+
  facet_wrap("month")+
  geom_text(aes(15, 25, label=month), data=accidents.per.month)+
  scale_fill_manual(
    values=severity.colors,
    breaks=rev(names(severity.colors)))+
  scale_x_continuous("day of the month", breaks=c(1, 10, 20, 30))+
  geom_point(aes(
    day.of.the.month, accident.i, fill=severity),
    data=accidents.cumsum)
```

Before examining the data table of counter locations, we first convert the name variable to unicode strings:

```{r}
(counter.locations <- data.table(montreal.bikes$counter.locations)[, .(
  lon = coord_X, lat = coord_Y,
  nom_comptage=iconv(nom_comptage, "latin1", "UTF-8"))])
```

In the output above, we see that the `nom_comptage` column indicates the location of the counter, but the values are not exactly the same as in the `location` column in the table of counts.

```{r}
loc.name.code <- c(
  "Berri1"="Berri",
  "Brebeuf"="Brébeuf",
  CSC="Côte-Sainte-Catherine",
  "Maisonneuve_1"="Maisonneuve 1",
  "Maisonneuve_2"="Maisonneuve 2",
  "Parc"="du Parc",
  PierDup="Pierre-Dupuy",
  "Rachel/Papineau"="Rachel",
  "Saint-Urbain"="Saint-Urbain",
  "Totem_Laurier"="Totem_Laurier")
counter.locations[, location := loc.name.code[nom_comptage] ]
velo.counts <- table(counts.dt$location)
(show.locations <- counter.locations[
  names(velo.counts), on=.(location)])
```

The counter locations above will be plotted below. Note that we use
`showSelected=month` and `clickSelects=location`.

```{r}
map.lim <- show.locations[, list(
  range.lat=range(lat),
  range.lon=range(lon)
)]
diff.vec <- sapply(map.lim, diff)
diff.mat <- c(-1, 1) * matrix(diff.vec, 2, 2, byrow=TRUE)
scale.mat <- as.matrix(map.lim) + diff.mat
location.colors <-
  c("#8DD3C7", "#FFFFB3", "#BEBADA", "#FB8072", "#80B1D3", "#FDB462", 
    "#B3DE69", "#FCCDE5", "#D9D9D9", "#BC80BD", "#CCEBC5", "#FFED6F")
names(location.colors) <- show.locations$location
counts.per.month.loc <- counts.per.month[
  show.locations, on=.(location)]
bike.paths <- data.table(montreal.bikes$path.locations)
some.paths <- bike.paths[
  scale.mat[1, "range.lat"] < lat &
    scale.mat[1, "range.lon"] < lon &
    lat < scale.mat[2, "range.lat"] &
    lon < scale.mat[2, "range.lon"]]
mtl.map <- ggplot()+
  theme_bw()+
  theme(
    panel.margin=grid::unit(0, "lines"),
    axis.line=element_blank(), axis.text=element_blank(), 
    axis.ticks=element_blank(), axis.title=element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank())+
  coord_equal(xlim=map.lim$range.lon, ylim=map.lim$range.lat)+
  scale_color_manual(values=location.colors)+
  scale_x_continuous(limits=scale.mat[, "range.lon"])+
  scale_y_continuous(limits=scale.mat[, "range.lat"])+
  geom_path(aes(
    lon, lat,
    tooltip=TYPE_VOIE,
    group=paste(feature.i, path.i)),
    color="grey",
    data=some.paths)+
  guides(color="none")+
  geom_text(aes(
    lon, lat,
    label=location),
    clickSelects="location",
    data=show.locations)
mtl.map
```

The plot below shows the time period that each counter was in
operation. Note that we use `geom_tallrect()` with `clickSelects` to
select the month.

```{r}
location.ranges <- counts.per.month[0 < count, list(
  min=min(month.POSIXct),
  max=max(month.POSIXct)
), by=location]
accidents.range <- accidents.dt[, data.table(
  location="accidents",
  min=min(date.POSIXct),
  max=max(date.POSIXct))]
MonthSummary <- ggplot()+
  theme_bw()+
  theme_animint(width=450, height=250)+
  xlab("range of dates in data")+
  ylab("data type")+
  scale_color_manual(values=location.colors)+
  guides(color="none")+
  geom_segment(aes(
    min, location,
    xend=max, yend=location,
    color=location),
    clickSelects="location",
    data=location.ranges, alpha=3/4, size=10)+
  geom_segment(aes(
    min, location,
    xend=max, yend=location),
    color=severity.colors[["deaths"]],
    data=accidents.range,
    size=10)
MonthSummary
```

The plot below shows the bike counts at each location and day.

```{r}
(dates <- counts.dt[, list(
  min.date = date-one.day/2,
  max.date = date+one.day/2,
  locations=sum(!is.na(count))
), by=list(date)][0 < locations])
location.labels <- counts.dt[
, .SD[which.max(count)]
, by=list(location)]
TimeSeries <- ggplot()+
  theme_bw()+
  geom_tallrect(aes(
    xmin=date-one.day/2, xmax=date+one.day/2,
    clickSelects=date),
    data=dates, alpha=1/2)+
  geom_line(aes(
    date, count, group=location,
    showSelected=location,
    clickSelects=location),
    data=counts.dt)+
  scale_color_manual(values=location.colors)+
  geom_point(aes(
    date, count, color=location,
    showSelected=location,
    clickSelects=location),
    data=counts.dt)+
  geom_text(aes(
    date, count+200, color=location, label=location,
    showSelected=location,
    clickSelects=location),
    data=location.labels)
TimeSeries
```

The plot below shows the same data but for each month.

```{r}
MonthSeries <- ggplot()+
  guides(color="none", fill="none")+
  theme_bw()+
  geom_tallrect(aes(
    xmin=month01.POSIXct, xmax=next01.POSIXct),
    clickSelects="month",    
    data=months,
    alpha=1/2)+
  geom_line(aes(
    month.POSIXct, count, group=location,
    color=location),
    showSelected="location",
    clickSelects="location",
    data=counts.per.month)+
  scale_color_manual(values=location.colors)+
  scale_fill_manual(values=location.colors)+
  xlab("month")+
  ylab("bike counts per month")+
  geom_point(aes(
    month.POSIXct, count, fill=location,
    tooltip=paste(
      count, "bikers counted at",
      location, "in", month)),
    showSelected="location",
    clickSelects="location",
    size=5,
    color="black",
    data=counts.per.month)+
  geom_text(aes(
    month.POSIXct, count+5000, color=location, label=location),
    showSelected="location",
    clickSelects="location",
    data=month.labels)
MonthSeries
```

```{r}
counter.title <- "mean cyclists/day"
accidents.title <- "city-wide accidents"
person_people <- function(num, suffix)ifelse(
  num==0, "",
  sprintf(
    "%d %s %s",
    num,
    ifelse(num==1, "person", "people"),
    suffix))
deaths_severe_slight <- function(deaths, severe, slight)apply(cbind(
  ifelse(
    deaths==0, "",
    sprintf(
      "%d death%s",
      deaths,
      ifelse(deaths==1, "", "s"))),
  person_people(severe, "severely injured"),
  person_people(slight, "slightly injured")),
  1, function(x)paste(x[x!=""], collapse=", "))
MonthFacet <- ggplot()+
  ggtitle("All data, select month")+
  guides(color="none", fill="none")+
  theme_bw()+
  facet_grid(facet ~ ., scales="free")+
  theme(panel.margin=grid::unit(0, "lines"))+
  geom_tallrect(aes(
    xmin=month01.POSIXct, xmax=next01.POSIXct),
    clickSelects="month",
    data=data.table(
      city.wide.cyclists,
      facet=counter.title),
    alpha=1/2)+
  geom_line(aes(
    month.POSIXct, mean.per.day, group=location,
    color=location),
    showSelected="location",
    clickSelects="location",
    data=data.table(counts.per.month, facet=counter.title))+
  scale_color_manual(values=location.colors)+
  xlab("month")+
  ylab("")+
  geom_point(aes(
    month.POSIXct, mean.per.day, color=location,
    tooltip=paste(
      count, "cyclists counted at",
      location, "in",
      days, "days of", month,
      sprintf("(mean %d cyclists/day)", as.integer(mean.per.day)))),
    showSelected="location",
    clickSelects="location",
    size=5,
    fill="grey",
    data=data.table(counts.per.month, facet=counter.title))+
  geom_text(aes(
    month.POSIXct, mean.per.day+300, color=location, label=location),
    showSelected="location",
    clickSelects="location",
    data=data.table(month.labels, facet=counter.title))+
  scale_fill_manual(values=severity.colors)+
  geom_bar(aes(
    month.POSIXct, people,
    fill=severity),
    showSelected="severity",
    stat="identity",
    position="identity",
    color=NA,
    data=data.table(accidents.tall, facet=accidents.title))+
  geom_tallrect(aes(
    xmin=month01.POSIXct, xmax=next01.POSIXct,
    tooltip=paste(
      deaths_severe_slight(
        deaths,
        people.severely.injured,
        people.slightly.injured),
      "in", month)),
    clickSelects="month",
    alpha=0.5,
    data=data.table(accidents.per.month, facet=accidents.title))
MonthFacet
```

```{r}
(days.dt <- data.table(
  day.POSIXct=with(months, seq(
    min(month01.POSIXct),
    max(next01.POSIXct),
    by="day"))
)[
, day.of.the.week := strftime(day.POSIXct, "%a")
][])
## The following only works in locales with English days of the week.
(weekend.dt <- days.dt[
  day.of.the.week %in% c("Sat", "Sun")
][, let(
  month.text = strftime(day.POSIXct, "%B %Y"),
  day.of.the.month = as.integer(strftime(day.POSIXct, "%d"))
)][
, month := factor(month.text, month.levs)
][])
counter.title <- "cyclists per day"
DaysFacet <- ggplot()+
  ggtitle("Selected month (weekends in grey)")+
  theme_bw()+
  theme_animint(colspan=2, last_in_row=TRUE)+
  geom_tallrect(aes(
    xmin=day.of.the.month-0.5, xmax=day.of.the.month+0.5,
    key=paste(day.POSIXct)),
    showSelected="month",
    fill="grey",
    color="white",
    data=weekend.dt)+
  guides(color="none")+
  facet_grid(facet ~ ., scales="free")+
  geom_line(aes(
    day.of.the.month, count, group=location,
    key=location,
    color=location),
    showSelected=c("location", "month"),
    clickSelects="location",
    chunk_vars=c("month"),
    data=data.table(counts.dt, facet=counter.title))+
  scale_color_manual(values=location.colors)+
  ylab("")+
  geom_point(aes(
    day.of.the.month, count, color=location,
    key=paste(day.of.the.month, location),
    tooltip=paste(
      count, "cyclists counted at",
      location, "on",
      date)),
    showSelected=c("location", "month"),
    clickSelects="location",
    size=5,
    chunk_vars=c("month"),
    fill="white",
    data=data.table(counts.dt, facet=counter.title))+
  scale_fill_manual(
    values=severity.colors,
    breaks=rev(names(severity.colors)))+
  geom_text(aes(
    15, 23, label=month, key=1),
    showSelected="month",
    data=data.table(months, facet=accidents.title))+
  scale_x_continuous("day of the month", breaks=c(1, 10, 20, 30))+
  geom_text(aes(
    day.of.the.month, count+500, color=location, label=location,
    key=location),
    showSelected=c("location", "month"),
    clickSelects="location",
    data=data.table(day.labels, facet=counter.title))+
  geom_point(aes(
    day.of.the.month, accident.i,
    key=paste(date.str, accident.i),
    tooltip=paste(
      deaths_severe_slight(
        deaths,
        people.severely.injured,
        people.slightly.injured),
      "at",
      ifelse(is.na(street.number), "", street.number),
      street, "/", cross.street,
      date.str, time.str),
    fill=severity),
    showSelected="month",
    size=4,
    chunk_vars=c("month"),
    data=data.table(accidents.cumsum, facet=accidents.title))
DaysFacet
```

```{r ch09-viz-mtl}
animint(
  DaysFacet,
  MonthFacet,
  MonthSummary,
  selector.types=list(severity="multiple"),
  duration=list(month=2000),
  first=list(
    location="Berri",
    month="September 2012"),
  time=list(variable="month", ms=5000))
```

## Chapter summary and exercises {#ch09-exercises}

Exercises:

* Change location to a multiple selection variable.
* Add a plot for the map to the data viz.
* On the map, draw a circle for each location, with size that changes
  based on the `count` of the accidents in the currently selected
  `month`.
* On the `MonthSummary` plot, add a background
  rectangle that can be used to select the `month`.
* Remove the `MonthSummary` plot and add a similar visualization as a
  third panel in the `MonthFacet` plot.

Next, [Chapter 10](/ch10) explains how to visualize the K-Nearest-Neighbors machine learning model.
